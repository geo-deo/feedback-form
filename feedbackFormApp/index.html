<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat test</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --accent:#4f46e5; --muted:#6b7280;
      --bubble-user:#eef2ff; --bubble-bot:#ffffff;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,-apple-system,Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px;}
    .frame{width:420px;height:640px;background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.08);display:flex;flex-direction:column;overflow:hidden;}
    .header{padding:16px;border-bottom:1px solid #eef2ff;color:#111;font-weight:600}
    .messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,#fff0,transparent);}
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,0.02);line-height:1.35;font-size:14px}
    .msg.left{align-self:flex-start;background:var(--bubble-bot);border:1px solid #f1f5f9}
    .msg.right{align-self:flex-end;background:var(--bubble-user);border:1px solid rgba(79,70,229,0.08)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px}
    .composer{display:flex;padding:12px;border-top:1px solid #eef2ff;gap:8px}
    .composer input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px}
    .composer button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .typing{font-style:italic;color:var(--muted);font-size:13px;}
    .small{font-size:12px;color:var(--muted);text-align:center;padding:8px}
  </style>
</head>
<body>
  <div class="frame" role="main">
    <div class="header">AI-—á–∞—Ç</div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="composer" aria-label="composer">
      <input id="inputMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

  <script>
    (function () {
      const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || 'http://localhost:3001';
      const API_URL = API_BASE.replace(/\/$/, '') + '/api/ai-chat';
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('inputMessage');
      const sendBtn = document.getElementById('sendBtn');

      // –£—Ç–∏–ª–∏—Ç—ã UI
      function appendMessage(text, side = 'left') {
        const el = document.createElement('div');
        el.className = 'msg ' + (side === 'left' ? 'left' : 'right');
        el.textContent = text;
        messagesEl.appendChild(el);
        scrollToBottom();
        return el;
      }
      function setTyping(on, text = 'AI –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶') {
        if (on) {
          if (!messagesEl.querySelector('.__typing')) {
            const el = document.createElement('div');
            el.className = 'msg left __typing';
            el.innerHTML = '<span class="typing">' + text + '</span>';
            messagesEl.appendChild(el);
            scrollToBottom();
          }
        } else {
          const t = messagesEl.querySelector('.__typing');
          if (t) t.remove();
        }
      }
      function scrollToBottom() {
        messagesEl.scrollTop = messagesEl.scrollHeight + 999;
      }

      // –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ (–≤–µ—Ä–Ω—ë—Ç 'ru'|'ko'|'zh'|'ar'|'en')
      function detectLang(text) {
        if (!text || !text.trim()) return 'en';
        const s = text;
        if (/[–∞-—è–ê-–Ø–Å—ë]/.test(s)) return 'ru';
        if (/[\u3131-\u318E\uAC00-\uD7A3]/.test(s)) return 'ko';
        if (/[\u4E00-\u9FFF]/.test(s)) return 'zh';
        if (/[\u0600-\u06FF]/.test(s)) return 'ar';
        if (/[√Ä-√ø]/.test(s) && /[A-Za-z]/.test(s)) return 'en';
        return 'en';
      }

      // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      appendMessage('üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?', 'left');

      // –û—Ç–ø—Ä–∞–≤–∫–∞
      async function sendMessage() {
        const val = inputEl.value.trim();
        if (!val) return;
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        appendMessage(val, 'right');
        inputEl.value = '';
        inputEl.focus();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç"
        setTyping(true);

        // –û–ø—Ä–µ–¥–µ–ª–∏–º —è–∑—ã–∫ –∏ –ø–æ—à–ª—ë–º –≤–º–µ—Å—Ç–µ
        const lang = detectLang(val);

        try {
          const resp = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: val, lang }),
          });

          if (!resp.ok) {
            const text = await resp.text().catch(()=>null);
            setTyping(false);
            appendMessage('‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ' + resp.status + (text ? ' ‚Äî '+text : ''), 'left');
            return;
          }

          const data = await resp.json().catch(()=>null);
          setTyping(false);

          // –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª –ø–æ–ª–µ reply ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –ø–æ–∫–∞–∂–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
          const reply = data && (data.reply || data.response || data.text) ? (data.reply || data.response || data.text) : (typeof data === 'string' ? data : JSON.stringify(data));
          appendMessage(reply || '‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'left');

        } catch (err) {
          setTyping(false);
          appendMessage('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + (err && err.message ? err.message : ''), 'left');
          console.error(err);
        }
      }

      // UI handlers
      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // accessibility focus
      inputEl.focus();
    })();
  </script>
</body>
</html>