<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Auth</title>
  <style>
    :root {
      --bg:#f3f4f6; --card:#fff; --accent:#4f46e5; --muted:#6b7280;
      --bubble-user:#eef2ff; --bubble-bot:#ffffff;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,system-ui,-apple-system,Roboto,"Helvetica Neue",Arial;}
    body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px;}
    .frame{width:420px;height:640px;background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.08);display:flex;flex-direction:column;overflow:hidden;}
    .messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:12px;}
    .msg{max-width:78%;padding:10px 12px;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,0.02);line-height:1.35;font-size:14px}
    .msg.left{align-self:flex-start;background:var(--bubble-bot);border:1px solid #f1f5f9}
    .msg.right{align-self:flex-end;background:var(--bubble-user);border:1px solid rgba(79,70,229,0.08)}
    .composer{display:flex;padding:12px;border-top:1px solid #eef2ff;gap:8px}
    .composer input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px}
    .composer button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .typing{font-style:italic;color:var(--muted);font-size:13px;}
    .auth{flex:1;display:flex;flex-direction:column;align-items:center;padding:32px;gap:12px;}
    .auth input{width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    .auth button{width:100%;background:var(--accent);color:#fff;border:none;padding:12px;border-radius:8px;font-size:15px;font-weight:500;cursor:pointer;transition:0.2s;}
    .auth button:hover{opacity:0.9}
    .tabs{display:flex;width:100%;margin-bottom:16px;border-bottom:1px solid #e5e7eb;}
    .tab{flex:1;text-align:center;padding:10px;cursor:pointer;font-weight:500;color:var(--muted);}
    .tab.active{color:var(--accent);border-bottom:2px solid var(--accent);}
    .status{font-size:13px;color:var(--muted);margin-top:8px;text-align:center;}
    .user-bar{padding:12px;text-align:center;font-size:13px;color:var(--muted);border-bottom:1px solid #f3f4f6;}
    .auth-logo{margin-top:40px;margin-bottom:20px;display:flex;flex-direction:column;align-items:center;gap:8px;}
    .logo-text{font-size:16px;font-weight:600;color:var(--accent);}
  </style>
</head>
<body>
  <div class="frame" role="main">

    <!-- üîπ –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authSection" class="auth">
      <div class="auth-logo">
        <!-- ‚úÖ –ù–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞ —á–∞—Ç–∞ -->
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" stroke="#4f46e5" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <div class="logo-text">AI Chat</div>
      </div>

      <div class="tabs">
        <div id="tabSignin" class="tab active">Sign In</div>
        <div id="tabSignup" class="tab">Sign Up</div>
      </div>
      <input type="email" id="authEmail" placeholder="Email" />
      <input type="password" id="authPassword" placeholder="Password" />
      <button id="authBtn">Sign In</button>
      <div id="authStatus" class="status"></div>
    </div>

    <!-- üîπ –ß–∞—Ç -->
    <div id="chatSection" style="display:none;flex:1;flex-direction:column">
      <div id="userBar" class="user-bar"></div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div class="composer" aria-label="composer">
        <input id="inputMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ‚ö° –í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const authSection = document.getElementById("authSection");
    const chatSection = document.getElementById("chatSection");
    const statusEl = document.getElementById("authStatus");
    const authBtn = document.getElementById("authBtn");
    const tabSignin = document.getElementById("tabSignin");
    const tabSignup = document.getElementById("tabSignup");
    let mode = "signin"; // signin | signup

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    function setMode(newMode) {
      mode = newMode;
      if (mode === "signin") {
        tabSignin.classList.add("active");
        tabSignup.classList.remove("active");
        authBtn.textContent = "Sign In";
      } else {
        tabSignup.classList.add("active");
        tabSignin.classList.remove("active");
        authBtn.textContent = "Sign Up";
      }
    }
    tabSignin.addEventListener("click", ()=>setMode("signin"));
    tabSignup.addEventListener("click", ()=>setMode("signup"));

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
    authBtn.addEventListener("click", async () => {
      const email = document.getElementById("authEmail").value;
      const password = document.getElementById("authPassword").value;

      try {
        let userCred;
        if (mode === "signup") {
          userCred = await createUserWithEmailAndPassword(auth, email, password);
          statusEl.textContent = "‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: " + userCred.user.email;
        } else {
          userCred = await signInWithEmailAndPassword(auth, email, password);
          statusEl.textContent = "‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: " + userCred.user.email;
        }

        const token = await userCred.user.getIdToken();
        afterLogin(token, userCred.user.email);

      } catch (err) {
        statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞: " + err.message;
      }
    });

    // –ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
    function afterLogin(token, email) {
      authSection.style.display = "none";
      chatSection.style.display = "flex";
      document.getElementById("userBar").textContent = "üë§ " + email;
      startChat(token);
    }

    // üîπ –õ–æ–≥–∏–∫–∞ —á–∞—Ç–∞
    function startChat(token) {
      const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || 'http://localhost:3001';
      const API_URL = API_BASE.replace(/\/$/, '') + '/api/ai-chat';
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('inputMessage');
      const sendBtn = document.getElementById('sendBtn');

      function appendMessage(text, side = 'left') {
        const el = document.createElement('div');
        el.className = 'msg ' + (side === 'left' ? 'left' : 'right');
        el.textContent = text;
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight + 999;
      }

      function setTyping(on, text = 'AI –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶') {
        if (on) {
          if (!messagesEl.querySelector('.__typing')) {
            const el = document.createElement('div');
            el.className = 'msg left __typing';
            el.innerHTML = '<span class="typing">' + text + '</span>';
            messagesEl.appendChild(el);
            messagesEl.scrollTop = messagesEl.scrollHeight + 999;
          }
        } else {
          const t = messagesEl.querySelector('.__typing');
          if (t) t.remove();
        }
      }

      appendMessage('üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?', 'left');

      async function sendMessage() {
        const val = inputEl.value.trim();
        if (!val) return;
        appendMessage(val, 'right');
        inputEl.value = '';
        inputEl.focus();

        setTyping(true);

        try {
          const resp = await fetch(API_URL, {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message: val }),
          });

          const data = await resp.json();
          setTyping(false);
          appendMessage(data.reply || "‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç", 'left');
        } catch (err) {
          setTyping(false);
          appendMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + err.message, 'left');
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }
  </script>
</body>
</html>