<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Auth</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --accent:#4f46e5; --muted:#6b7280;
      --bubble-user:#eef2ff; --bubble-bot:#ffffff;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family: Inter, Segoe UI, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; background:var(--bg); }

    /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    .frame{
      height:100vh; height:100dvh; height:100svh;               /* —É—Å—Ç–æ–π—á–∏–≤–µ–µ –∫ –º–æ–±–∏–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ */
      max-width:980px;             /* —á–∞—Ç —à–∏—Ä–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
      margin:0 auto;               /* –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      background:var(--card);
      border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,.08);
      display:flex;
      flex-direction:column;
      overflow:hidden;             /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
    }

    /* ---------- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---------- */
    .auth-screen{ flex:1; display:grid; place-items:center; padding:24px; }
    .auth-card{ width:100%; max-width:420px; display:flex; flex-direction:column; gap:12px; }
    .auth-logo{ margin:8px 0 6px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .logo-text{ font-size:16px; font-weight:600; color:var(--accent); }
    .tabs{ display:flex; width:100%; margin:8px 0 4px; border-bottom:1px solid #e5e7eb; }
    .tab{ flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:500; color:var(--muted); }
    .tab.active{ color:var(--accent); border-bottom:2px solid var(--accent); }
    .auth-card input{ width:100%; padding:12px; border:1px solid #e6e9ef; border-radius:10px; font-size:14px; }
    .auth-card button{ width:100%; background:var(--accent); color:#fff; border:none; padding:12px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:opacity .2s; }
    .auth-card button:hover{ opacity:.9; }
    .status{ font-size:13px; color:var(--muted); margin-top:6px; text-align:center; min-height:18px; }

    /* ---------- –≠–ö–†–ê–ù –ß–ê–¢–ê ---------- */
    .chat-screen{ flex:1 1 auto; min-height:0; display:none; flex-direction:column; }
    .chat-screen.show{ display:flex; }
    .user-bar{ padding:12px; display:flex; align-items:center; justify-content:space-between; font-size:13px; color:var(--muted); border-bottom:1px solid #f3f4f6; }
    .link-btn{ background:transparent; border:none; color:var(--accent); font-weight:600; cursor:pointer; padding:6px 10px; border-radius:8px; }
    .link-btn:hover{ background:#eef2ff; }

    .messages{ flex:1 1 auto; min-height:0; padding:16px; overflow-y:auto; overscroll-behavior:contain; display:flex; flex-direction:column; gap:12px; }
    .msg{ max-width:78%; padding:10px 12px; border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,.02); line-height:1.35; font-size:14px; }
    .msg.left{ align-self:flex-start; background:var(--bubble-bot); border:1px solid #f1f5f9; }
    .msg.right{ align-self:flex-end; background:var(--bubble-user); border:1px solid rgba(79,70,229,.08); }
    .typing{ font-style:italic; color:var(--muted); font-size:13px; }

    .composer{ flex-shrink:0; display:flex; gap:8px; padding:12px; border-top:1px solid #eef2ff; background:var(--card); padding-bottom:calc(12px + env(safe-area-inset-bottom)); }
    .composer input{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e6e9ef; font-size:14px; }
    .composer button{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; white-space:nowrap; }

    @media (max-width:640px){
      .frame{ max-width:100%; border-radius:0; box-shadow:none; }
    }
  </style>
</head>
<body>
  <div class="frame" role="main">
    <!-- üîπ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <section id="authSection" class="auth-screen">
      <div class="auth-card" role="form" aria-labelledby="authTitle">
        <div class="auth-logo">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" stroke="#4f46e5" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <div id="authTitle" class="logo-text">AI Chat</div>
        </div>
        <div class="tabs" role="tablist">
          <div id="tabSignin" class="tab active" role="tab" aria-selected="true">Sign In</div>
          <div id="tabSignup" class="tab" role="tab" aria-selected="false">Sign Up</div>
        </div>
        <input type="email" id="authEmail" placeholder="Email" autocomplete="email" />
        <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password" />
        <button id="authBtn">Sign In</button>
        <div id="authStatus" class="status" aria-live="polite"></div>
      </div>
    </section>

    <!-- üîπ –ß–∞—Ç -->
    <section id="chatSection" class="chat-screen" aria-hidden="true">
      <div id="userBar" class="user-bar"><span id="userEmail"></span><button id="newChatBtn" class="link-btn" type="button">New chat</button></div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div class="composer" aria-label="composer">
        <input id="inputMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>

  <!-- üîπ Firebase + –ª–æ–≥–∏–∫–∞ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ‚ö° –¢–≤–æ–π Firebase config (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π ‚Äî –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–¥–µ)
    const firebaseConfig = {
      apiKey: "AIzaSyCCE7xEdDgukUVN_zNRQwbg9LHiuHCSDCA",
      authDomain: "feedback-form-c4ea0.firebaseapp.com",
      projectId: "feedback-form-c4ea0",
      storageBucket: "feedback-form-c4ea0.firebasestorage.app",
      messagingSenderId: "617989343890",
      appId: "1:617989343890:web:4a5fd70d58267b35f4b44b",
      measurementId: "G-JRV5EMMSTE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const authSection = document.getElementById("authSection");
    const chatSection = document.getElementById("chatSection");
    const statusEl = document.getElementById("authStatus");
    const authBtn = document.getElementById("authBtn");
    const tabSignin = document.getElementById("tabSignin");
    const tabSignup = document.getElementById("tabSignup");
    let mode = "signin"; // signin | signup

    function setMode(newMode){
      mode = newMode;
      const isSignIn = mode === "signin";
      tabSignin.classList.toggle("active", isSignIn);
      tabSignup.classList.toggle("active", !isSignIn);
      authBtn.textContent = isSignIn ? "Sign In" : "Sign Up";
      statusEl.textContent = "";
    }
    tabSignin.addEventListener("click", ()=>setMode("signin"));
    tabSignup.addEventListener("click", ()=>setMode("signup"));

    authBtn.addEventListener("click", doAuth);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && (document.activeElement.id==="authEmail" || document.activeElement.id==="authPassword")) doAuth(); });

    async function doAuth(){
      const email = (document.getElementById("authEmail").value || "").trim();
      const password = document.getElementById("authPassword").value || "";
      if(!email || !password){ statusEl.textContent = "–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å"; return; }
      try{
        let userCred;
        if(mode === "signup"){
          userCred = await createUserWithEmailAndPassword(auth, email, password);
          statusEl.textContent = "‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: " + userCred.user.email;
        }else{
          userCred = await signInWithEmailAndPassword(auth, email, password);
          statusEl.textContent = "‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: " + userCred.user.email;
        }
        const token = await userCred.user.getIdToken();
        afterLogin(token, userCred.user.email);
      }catch(err){
        statusEl.textContent = "‚ùå –û—à–∏–±–∫–∞: " + (err?.message || err);
      }
    }

    function afterLogin(token, email){
      // –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç, —Å–ø—Ä—è—Ç–∞—Ç—å auth
      authSection.style.display = "none";
      chatSection.classList.add("show");
      chatSection.setAttribute("aria-hidden", "false");
      document.getElementById("userBar").textContent = "üë§ " + email;
      // Rebuild user bar to include New chat button and email
      const userBar = document.getElementById("userBar");
      if (userBar) {
        userBar.innerHTML = '<span id="userEmail"></span><button id="newChatBtn" class="link-btn" type="button">New chat</button>';
        const emailEl = document.getElementById("userEmail");
        if (emailEl) emailEl.textContent = email;
      }
      startChat(token);
    }

    // ---------- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ----------
    function startChat(token){
      const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || "http://localhost:3001"; // –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const API_URL = API_BASE.replace(/\/$/, '') + '/api/ai-chat';

      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('inputMessage');
      const sendBtn = document.getElementById('sendBtn');
      const newChatBtn = document.getElementById('newChatBtn');
      const emailForKey = (document.getElementById('userEmail')?.textContent || 'anonymous');
      const chatKey = `chatId:${emailForKey}`;
      let chatId = null;
      try { chatId = localStorage.getItem(chatKey) || null; } catch(_) {}

      function scrollBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight + 999; }
      function appendMessage(text, side='left'){
        const el = document.createElement('div');
        el.className = 'msg ' + (side === 'left' ? 'left' : 'right');
        el.textContent = text;
        messagesEl.appendChild(el);
        scrollBottom();
      }
      function setTyping(on, text='AI –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶'){
        if(on){
          if(!messagesEl.querySelector('.__typing')){
            const el = document.createElement('div');
            el.className = 'msg left __typing';
            el.innerHTML = '<span class="typing">'+text+'</span>';
            messagesEl.appendChild(el);
            scrollBottom();
          }
        } else {
          messagesEl.querySelector('.__typing')?.remove();
        }
      }

      appendMessage('üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?', 'left');

      async function sendMessage(){
        const val = (inputEl.value || '').trim();
        if(!val) return;
        appendMessage(val, 'right');
        inputEl.value = '';
        inputEl.focus();
        setTyping(true);
        try{
          const resp = await fetch(API_URL, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ message: val, chatId })
          });
          const data = await resp.json().catch(()=>({ reply:'‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞' }));
          if (data && data.chatId && !chatId) {
            chatId = data.chatId;
            try { localStorage.setItem(chatKey, chatId); } catch(_) {}
          }
          setTyping(false);
          appendMessage(data.reply || '‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç', 'left');
        }catch(err){
          setTyping(false);
          appendMessage('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + (err?.message || err), 'left');
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

      // Load history strictly for current chat (if chatId known)
      (async () => {
        if (!chatId) return;
        try {
          const base = API_BASE.replace(/\/$/, '');
          const resp = await fetch(`${base}/api/ai-chat/history?limit=50&chatId=${encodeURIComponent(chatId)}`, {
            headers: { 'Authorization': `Bearer ${token}` },
          });
          const data = await resp.json();
          if (data?.ok && Array.isArray(data.items)) {
            messagesEl.innerHTML = '';
            data.items.forEach(m => appendMessage(m.content, m.role === 'user' ? 'right' : 'left'));
          }
        } catch(_) { /* ignore */ }
      })();

      // New chat: reset stored chatId and clear message view
      if (newChatBtn) {
        newChatBtn.addEventListener('click', () => {
          try { localStorage.removeItem(chatKey); } catch(_) {}
          chatId = null;
          messagesEl.innerHTML = '';
          appendMessage('–ù–æ–≤—ã–π —á–∞—Ç –Ω–∞—á–∞—Ç. –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.', 'left');
          inputEl.focus();
        });
      }
    }
  </script>
</body>
</html>
