<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat with Auth</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#fff; --accent:#4f46e5; --muted:#6b7280;
      --bubble-user:#eef2ff; --bubble-bot:#ffffff;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{ margin:0; font-family: Inter, Segoe UI, system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; background:var(--bg); }

    /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
    .frame{
      height:100vh; height:100dvh; height:100svh;               /* —É—Å—Ç–æ–π—á–∏–≤–µ–µ –∫ –º–æ–±–∏–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ */
      max-width:980px;             /* —á–∞—Ç —à–∏—Ä–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
      margin:0 auto;               /* –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      background:var(--card);
      border-radius:12px;
      box-shadow:0 8px 30px rgba(2,6,23,.08);
      display:flex;
      flex-direction:column;
      overflow:hidden;             /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ */
    }

    /* ---------- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---------- */
    .auth-screen{ flex:1; display:grid; place-items:center; padding:24px; }
    .auth-card{ width:100%; max-width:420px; display:flex; flex-direction:column; gap:12px; }
    .auth-logo{ margin:8px 0 6px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .logo-text{ font-size:16px; font-weight:600; color:var(--accent); }
    .tabs{ display:flex; width:100%; margin:8px 0 4px; border-bottom:1px solid #e5e7eb; }
    .tab{ flex:1; text-align:center; padding:10px; cursor:pointer; font-weight:500; color:var(--muted); }
    .tab.active{ color:var(--accent); border-bottom:2px solid var(--accent); }
    .auth-card input{ width:100%; padding:12px; border:1px solid #e6e9ef; border-radius:10px; font-size:14px; }
    .auth-card button{ width:100%; background:var(--accent); color:#fff; border:none; padding:12px; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer; transition:opacity .2s; }
    .auth-card button:hover{ opacity:.9; }
    .status{ font-size:13px; color:var(--muted); margin-top:6px; text-align:center; min-height:18px; }

    /* ---------- –≠–ö–†–ê–ù –ß–ê–¢–ê ---------- */
    .chat-screen{ flex:1 1 auto; min-height:0; display:none; flex-direction:column; }
    .chat-screen.show{ display:flex; }
    .user-bar{ padding:12px; display:flex; align-items:center; justify-content:space-between; font-size:13px; color:var(--muted); border-bottom:1px solid #f3f4f6; }
    .link-btn{ background:transparent; border:none; color:var(--accent); font-weight:600; cursor:pointer; padding:6px 10px; border-radius:8px; }
    .link-btn:hover{ background:#eef2ff; }

    .messages{ flex:1 1 auto; min-height:0; padding:16px; overflow-y:auto; overscroll-behavior:contain; display:flex; flex-direction:column; gap:12px; }
    .msg{ max-width:78%; padding:10px 12px; border-radius:12px; box-shadow:0 1px 0 rgba(0,0,0,.02); line-height:1.35; font-size:14px; }
    .msg.left{ align-self:flex-start; background:var(--bubble-bot); border:1px solid #f1f5f9; }
    .msg.right{ align-self:flex-end; background:var(--bubble-user); border:1px solid rgba(79,70,229,.08); }
    .typing{ font-style:italic; color:var(--muted); font-size:13px; }

    .composer{ flex-shrink:0; display:flex; gap:8px; padding:12px; border-top:1px solid #eef2ff; background:var(--card); padding-bottom:calc(12px + env(safe-area-inset-bottom)); }
    .composer input{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid #e6e9ef; font-size:14px; }
    .composer button{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; white-space:nowrap; }

    @media (max-width:640px){
      .frame{ max-width:100%; border-radius:0; box-shadow:none; }
    }

    /* Sidebar layout additions */
    .chat-screen.show{ display:grid; grid-template-columns:auto 1fr; grid-template-rows:auto 1fr auto; }
    #sidebar{ grid-column:1; grid-row:1 / span 3; }
    #userBar{ grid-column:2; grid-row:1; }
    #messages{ grid-column:2; grid-row:2; }
    .composer{ grid-column:2; grid-row:3; }

    .sidebar{ background:#f8fafc; border-right:1px solid #e5e7eb; display:flex; flex-direction:column; width:280px; transition:width .2s ease; }
    .sidebar.collapsed{ width:72px; }
    .sidebar[hidden]{ display:none !important; }
    .sb-top{ padding:8px; display:flex; flex-direction:column; gap:8px; border-bottom:1px solid #f3f4f6; }
    /* brand row: logo at left, subtle toggle on right */
    .sb-brand-row{ display:flex; align-items:center; justify-content:space-between; padding:6px 4px; }
    .sb-logo{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:8px; background:var(--accent); color:#fff; font-weight:700; font-size:14px; user-select:none; }
    .sb-icon-btn{ appearance:none; border:none; background:transparent; color:#6b7280; display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:6px; cursor:pointer; opacity:.55; transition:opacity .15s ease, background-color .15s ease; }
    .sb-icon-btn:hover{ background:#eef2ff; opacity:.9; }
    .sb-btn{ display:flex; align-items:center; gap:8px; width:100%; border:none; background:transparent; padding:10px 12px; border-radius:8px; cursor:pointer; color:#111827; }
    .sb-btn:hover{ background:#eef2ff; }
    .sb-icon{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; border:1px solid #e5e7eb; border-radius:4px; font-weight:700; color:#6b7280; }
    .sb-text{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .sidebar.collapsed .sb-text{ display:none; }
    .sb-list{ flex:1 1 auto; min-height:0; overflow:auto; padding:8px; display:flex; flex-direction:column; gap:6px; }
    .sidebar.collapsed .sb-list{ display:none; }
    .chat-item{ display:flex; align-items:center; gap:8px; text-align:left; width:100%; border:none; background:transparent; padding:8px 10px; border-radius:8px; cursor:pointer; color:#111827; }
    .chat-item:hover{ background:#f8fafc; }
    .chat-item.active{ background:#eef2ff; color:#3730a3; }
    .chat-item .dot{ width:6px; height:6px; border-radius:50%; background:#d1d5db; flex:0 0 6px; }
    .sidebar.collapsed .chat-item .title{ display:none; }
    .sidebar.collapsed .chat-item{ justify-content:center; }
    /* Sidebar account row: match composer height and vertical centering */
    .sb-account{
      margin-top:auto;
      border-top:1px solid #f3f4f6;
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      column-gap:10px;
      padding:12px;
      padding-left:0;                   /* place avatar center closer to frame edge */
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .avatar{ width:32px; height:32px; line-height:32px; font-size:14px; border-radius:50%; background:#e5e7eb; color:#111827; font-weight:700; display:inline-flex; align-items:center; justify-content:center; margin-left:calc(16px + env(safe-area-inset-left)); }
    .acc-info{ display:flex; flex-direction:column; font-size:12px; color:#6b7280; min-width:0; }
    .acc-info .name{ color:#111827; font-weight:600; }
    .sidebar.collapsed .acc-info{ display:none; }
    .sidebar.collapsed .signout-btn{ display:none; }
    .signout-btn{ margin-left:auto; background:transparent; border:none; color:#ef4444; cursor:pointer; font-size:12px; border-radius:6px; padding:6px 8px; }
    .signout-btn:hover{ background:#fef2f2; }
    /* Hide legacy New chat in top bar */
    .user-bar #newChatBtn{ display:none; }
    .user-bar #userEmail{ display:none; }

    /* Collapsed behavior: show only logo; reveal toggle on hover */
    .sidebar.collapsed .sb-brand-row{ position:relative; justify-content:center; }
    .sidebar.collapsed #sbToggle{ position:absolute; right:6px; top:50%; transform:translateY(-50%); opacity:0; pointer-events:none; }
    .sidebar.collapsed .sb-brand-row:hover #sbToggle{ opacity:1; pointer-events:auto; }
    /* Center icons when collapsed */
    .sidebar.collapsed .sb-btn{ justify-content:center; padding-left:0; padding-right:0; }

    /* Center user avatar in collapsed sidebar */
    .sidebar.collapsed .sb-account{
      grid-template-columns: 1fr;
      justify-items: center;
    }
    .sidebar.collapsed .avatar{
      margin-left: 0;
      justify-self: center;
    }
    .sidebar.collapsed .sb-account{ justify-content:center; }
  </style>
</head>
<body>
  <div class="frame" role="main">
    <!-- üîπ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <section id="authSection" class="auth-screen">
      <div class="auth-card" role="form" aria-labelledby="authTitle">
        <div class="auth-logo">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" stroke="#4f46e5" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <div id="authTitle" class="logo-text">AI Chat</div>
        </div>
        <div class="tabs" role="tablist">
          <div id="tabSignin" class="tab active" role="tab" aria-selected="true">Sign In</div>
          <div id="tabSignup" class="tab" role="tab" aria-selected="false">Sign Up</div>
        </div>
        <input type="email" id="authEmail" placeholder="Email" autocomplete="email" />
        <input type="password" id="authPassword" placeholder="Password" autocomplete="current-password" />
        <button id="authBtn">Sign In</button>
        <div id="authStatus" class="status" aria-live="polite"></div>
      </div>
    </section>

    <!-- üîπ –ß–∞—Ç -->
    <section id="chatSection" class="chat-screen" aria-hidden="true">
      <aside id="sidebar" class="sidebar collapsed" aria-expanded="false" hidden>
        <div class="sb-top">
          <div class="sb-brand-row">
            <div id="sbLogo" class="sb-logo" title="Product">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
              </svg>
            </div>
            <button id="sbToggle" class="sb-icon-btn" aria-label="Toggle sidebar" title="Toggle sidebar">
              <span class="sb-icon">‚â°</span>
            </button>
          </div>
          <button id="newChatBtn" class="sb-btn" type="button">
            <span class="sb-icon">Ôºã</span>
            <span class="sb-text">New chat</span>
          </button>
        </div>
        <div id="chatList" class="sb-list" aria-label="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤"></div>
        <div class="sb-account">
          <div id="userAvatar" class="avatar">?</div>
          <div class="acc-info">
            <div id="accName" class="name"></div>
            <div id="accEmail" class="email"></div>
          </div>
          <button id="signOutBtn" class="signout-btn" type="button">–í—ã—Ö–æ–¥</button>
        </div>
      </aside>
      <div id="userBar" class="user-bar"><span id="userEmail"></span><button id="newChatBtn" class="link-btn" type="button">New chat</button></div>
      <div id="messages" class="messages" aria-live="polite"></div>
      <div class="composer" aria-label="composer">
        <input id="inputMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." aria-label="–°–æ–æ–±—â–µ–Ω–∏–µ" />
        <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </section>
  </div>

  <!-- üîπ Firebase + –ª–æ–≥–∏–∫–∞ -->
  <script src="config.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // ‚ö° –¢–≤–æ–π Firebase config (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π ‚Äî –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–æ–¥–µ)
    const firebaseConfig = {
      apiKey: "AIzaSyCCE7xEdDgukUVN_zNRQwbg9LHiuHCSDCA",
      authDomain: "feedback-form-c4ea0.firebaseapp.com",
      projectId: "feedback-form-c4ea0",
      storageBucket: "feedback-form-c4ea0.firebasestorage.app",
      messagingSenderId: "617989343890",
      appId: "1:617989343890:web:4a5fd70d58267b35f4b44b",
      measurementId: "G-JRV5EMMSTE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const authSection = document.getElementById("authSection");
    const chatSection = document.getElementById("chatSection");
    const statusEl = document.getElementById("authStatus");
    const authBtn = document.getElementById("authBtn");
    const tabSignin = document.getElementById("tabSignin");
    const tabSignup = document.getElementById("tabSignup");
    let mode = "signin"; // signin | signup

    function setMode(newMode){
      mode = newMode;
      const isSignIn = mode === "signin";
      tabSignin.classList.toggle("active", isSignIn);
      tabSignup.classList.toggle("active", !isSignIn);
      authBtn.textContent = isSignIn ? "Sign In" : "Sign Up";
      statusEl.textContent = "";
    }
    tabSignin.addEventListener("click", ()=>setMode("signin"));
    tabSignup.addEventListener("click", ()=>setMode("signup"));

    authBtn.addEventListener("click", doAuth);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && (document.activeElement.id==="authEmail" || document.activeElement.id==="authPassword")) doAuth(); });

    async function doAuth(){
      const email = (document.getElementById("authEmail").value || "").trim();
      const password = document.getElementById("authPassword").value || "";
      if(!email || !password){ statusEl.textContent = "Enter your email and password"; return; }
      try{
        let userCred;
        if(mode === "signup"){
          userCred = await createUserWithEmailAndPassword(auth, email, password);
          statusEl.textContent = "‚úÖ Signed Up: " + userCred.user.email;
        }else{
          userCred = await signInWithEmailAndPassword(auth, email, password);
          statusEl.textContent = "‚úÖ Signed In: " + userCred.user.email;
        }
        const token = await userCred.user.getIdToken();
        afterLogin(token, userCred.user.email);
      }catch(err){
        statusEl.textContent = "‚ùå Error: " + (err?.message || err);
      }
    }

    function afterLogin(token, email){
      // –ü–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç, —Å–ø—Ä—è—Ç–∞—Ç—å auth
      authSection.style.display = "none";
      chatSection.classList.add("show");
      chatSection.setAttribute("aria-hidden", "false");
      // Remove any header text (no email in header)
      try { document.getElementById("userBar").textContent = ""; } catch(_) {}
      document.getElementById("userBar").textContent = "üë§ " + email;
      document.getElementById("userBar").textContent = "";
      // Fill email and prepare sidebar
      const emailEl = document.getElementById("userEmail");
      if (emailEl) emailEl.textContent = email;

      const sidebar = document.getElementById('sidebar');
      sidebar.hidden = false;
      const accEmail = document.getElementById('accEmail');
      if (accEmail) accEmail.textContent = email;
      const accName = document.getElementById('accName');
      if (accName) accName.textContent = email.split('@')[0];
      const avatar = document.getElementById('userAvatar');
      if (avatar) avatar.textContent = (email[0] || '?').toUpperCase();

      // Normalize sidebar UI strings to English
      try {
        const sbText = document.querySelector('#sbToggle .sb-text');
        if (sbText) sbText.textContent = 'Menu';
        const sbToggle = document.getElementById('sbToggle');
        if (sbToggle) { sbToggle.title = 'Toggle sidebar'; sbToggle.setAttribute('aria-label','Toggle sidebar'); }
        const sbIcon = document.querySelector('#sbToggle .sb-icon');
        if (sbIcon) sbIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16"/><path d="M4 12h10"/><path d="M4 18h16"/></svg>';
        const newBtn = document.getElementById('newChatBtn');
        if (newBtn) { newBtn.title = 'New chat'; newBtn.setAttribute('aria-label','New chat'); }
        const chatList = document.getElementById('chatList');
        if (chatList) chatList.setAttribute('aria-label','Chat history');
        const signOutBtn = document.getElementById('signOutBtn');
        if (signOutBtn) signOutBtn.textContent = 'Sign out';
      } catch(_) {}

      // Remove legacy New chat in top bar if it exists
      document.querySelector('#userBar #newChatBtn')?.remove();

      // Sidebar toggle state per user
      const sbKey = `sb:collapsed:${email}`;
      try {
        const isCollapsed = localStorage.getItem(sbKey) === '1';
        sidebar.classList.toggle('collapsed', isCollapsed);
        sidebar.setAttribute('aria-expanded', String(!isCollapsed));
      } catch(_) {}
      document.getElementById('sbToggle')?.addEventListener('click', () => {
        const isCollapsed = !sidebar.classList.contains('collapsed');
        sidebar.classList.toggle('collapsed', isCollapsed);
        sidebar.setAttribute('aria-expanded', String(!isCollapsed));
        try { localStorage.setItem(sbKey, isCollapsed ? '1' : '0'); } catch(_) {}
      });

      document.getElementById('signOutBtn')?.addEventListener('click', async () => {
        try { await signOut(auth); } catch(_) {}
        chatSection.classList.remove('show');
        chatSection.setAttribute('aria-hidden', 'true');
        authSection.style.display = '';
        sidebar.hidden = true;
      });

      // For existing users: check if any chats exist and, if yes,
      // ensure the chat list is visible by default (auto-expand once).
      (async () => {
        try {
          const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || 'http://localhost:3001';
          const base = API_BASE.replace(/\/$/, '');
          const resp = await fetch(`${base}/api/ai-chat/history?limit=1`, {
            headers: { 'Authorization': `Bearer ${token}` },
          });
          const data = await resp.json();
          if (data?.ok && Array.isArray(data.items) && data.items.length > 0) {
            // Only auto-expand if user has no stored preference
            const pref = localStorage.getItem(sbKey);
            if (pref === null || pref === undefined) {
              sidebar.classList.remove('collapsed');
              sidebar.setAttribute('aria-expanded', 'true');
            }
          }
        } catch(_) { /* ignore */ }
      })();

      startChat(token);
    }

    // ---------- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ----------
    function startChat(token){
      const API_BASE = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || "http://localhost:3001"; // –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const API_URL = API_BASE.replace(/\/$/, '') + '/api/ai-chat';

      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('inputMessage');
      const sendBtn = document.getElementById('sendBtn');
      const newChatBtn = document.getElementById('newChatBtn');
      try { inputEl.placeholder = 'Type a message...'; sendBtn.textContent = 'Send'; } catch(_) {}
      const chatListEl = document.getElementById('chatList');
      const emailForKey = (document.getElementById('userEmail')?.textContent || 'anonymous');
      const chatKey = `chatId:${emailForKey}`;
      let chatId = null;
      try { chatId = localStorage.getItem(chatKey) || null; } catch(_) {}
      const listLSKey = `chats:${emailForKey}`;
      let lastUserText = '';

      function scrollBottom(){ messagesEl.scrollTop = messagesEl.scrollHeight + 999; }
      function appendMessage(text, side='left'){
        const el = document.createElement('div');
        el.className = 'msg ' + (side === 'left' ? 'left' : 'right');
        el.textContent = text;
        messagesEl.appendChild(el);
        scrollBottom();
      }
      function setTyping_EN(on){ try{ setTyping(on, 'AI is typing‚Ä¶'); }catch(_){ /* fallback */ } }
      function setTyping(on, text='AI –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶'){
        if(on){
          if(!messagesEl.querySelector('.__typing')){
            const el = document.createElement('div');
            el.className = 'msg left __typing';
            el.innerHTML = '<span class="typing">'+text+'</span>';
            messagesEl.appendChild(el);
            scrollBottom();
          }
        } else {
          messagesEl.querySelector('.__typing')?.remove();
        }
      }

      appendMessage('üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?', 'left');

      // Ensure EN greeting
      try { messagesEl.innerHTML = ''; appendMessage('üëã Hello! How can I help?', 'left'); } catch(_) {}

      async function sendMessage(){
        const val = (inputEl.value || '').trim();
        if(!val) return;
        appendMessage(val, 'right');
        inputEl.value = '';
        inputEl.focus();
        setTyping_EN(true);
        lastUserText = val;
        try{
          const resp = await fetch(API_URL, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ message: val, chatId })
          });
          const data = await resp.json().catch(()=>({ reply:'‚ö†Ô∏è Server Returned an Error' }));
          if (data && data.chatId && !chatId) {
            chatId = data.chatId;
            try { localStorage.setItem(chatKey, chatId); } catch(_) {}
            try {
              const arr = JSON.parse(localStorage.getItem(listLSKey) || '[]');
              const idx = arr.findIndex(c => c.id === chatId);
              const snippet = (lastUserText || '').replace(/\s+/g,' ').trim();
              if (idx === -1) arr.unshift({ id: chatId, snippet, updatedAt: Date.now() });
              else { arr[idx].snippet = snippet; arr[idx].updatedAt = Date.now(); }
              localStorage.setItem(listLSKey, JSON.stringify(arr.slice(0,50)));
            } catch(_) {}
            try { refreshChatList && refreshChatList(); } catch(_) {}
          }
          setTyping(false);
          appendMessage(data.reply || '‚ö†Ô∏è Empty Response', 'left');
        }catch(err){
          setTyping(false);
          appendMessage('‚ùå Connection Error: ' + (err?.message || err), 'left');
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

      // Load history strictly for current chat (if chatId known)
      (async () => {
        if (!chatId) return;
        try {
          const base = API_BASE.replace(/\/$/, '');
          const resp = await fetch(`${base}/api/ai-chat/history?limit=50&chatId=${encodeURIComponent(chatId)}`, {
            headers: { 'Authorization': `Bearer ${token}` },
          });
          const data = await resp.json();
          if (data?.ok && Array.isArray(data.items)) {
            messagesEl.innerHTML = '';
            data.items.forEach(m => appendMessage(m.content, m.role === 'user' ? 'right' : 'left'));
          }
        } catch(_) { /* ignore */ }
      })();

      // If nothing loaded, show English greeting
      if (!messagesEl.querySelector('.msg')) {
        messagesEl.innerHTML = '';
        appendMessage('Hi! How can I help?', 'left');
      }

      async function loadChatMessages(id){
        try {
          const base = API_BASE.replace(/\/$/, '');
          const resp = await fetch(`${base}/api/ai-chat/history?limit=200&chatId=${encodeURIComponent(id)}`, {
            headers: { 'Authorization': `Bearer ${token}` },
          });
          const data = await resp.json();
          if (data?.ok && Array.isArray(data.items)) {
            messagesEl.innerHTML = '';
            data.items.forEach(m => appendMessage(m.content, m.role === 'user' ? 'right' : 'left'));
          }
        } catch(_) { /* ignore */ }
      }

      function openChat(id){
        chatId = id;
        try { localStorage.setItem(chatKey, chatId); } catch(_) {}
        messagesEl.innerHTML = '';
        appendMessage('Loading history...', 'left');
        loadChatMessages(id).then(() => highlightActive());
      }

      function highlightActive(){
        const nodes = chatListEl?.querySelectorAll('.chat-item');
        nodes?.forEach(n => n.classList.toggle('active', n.getAttribute('data-id') === chatId));
      }

      function buildListFrom(items){
        if(!chatListEl) return;
        chatListEl.innerHTML = '';
        const frag = document.createDocumentFragment();
        items.forEach(it => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'chat-item';
          btn.setAttribute('data-id', it.id);
          btn.innerHTML = `<span class=\"dot\"></span><span class=\"title\">${it.snippet}</span>`;
          btn.addEventListener('click', () => openChat(it.id));
          // Build DOM-safe content (avoid HTML escaping issues)
          btn.replaceChildren();
          const sDot = document.createElement('span'); sDot.className = 'dot';
          const sTitle = document.createElement('span'); sTitle.className = 'title'; sTitle.textContent = it.snippet;
          btn.appendChild(sDot); btn.appendChild(sTitle);
          frag.appendChild(btn);
        });
        chatListEl.appendChild(frag);
        highlightActive();
      }

      async function refreshChatList(){
        const base = API_BASE.replace(/\/$/, '');
        try{
          const resp = await fetch(`${base}/api/ai-chat/history?limit=200`, { headers:{ 'Authorization': `Bearer ${token}` }});
          const data = await resp.json();
          if(data?.ok && Array.isArray(data.items)){
            const map = new Map();
            data.items.forEach(m => {
              const id = m.chatId || 'unknown';
              const ts = new Date(m.createdAt || Date.now()).getTime();
              const s = (m.content || '').replace(/\s+/g,' ').trim();
              const o = map.get(id) || { id, lastTs:0, lastUser:'', lastAssistant:'' };
              if (ts > o.lastTs) o.lastTs = ts;
              if (m.role === 'user') o.lastUser = s || o.lastUser; else o.lastAssistant = s || o.lastAssistant;
              map.set(id, o);
            });
            const arr = Array.from(map.values())
              .map(o => ({ id:o.id, snippet:(o.lastUser || o.lastAssistant || '–ù–æ–≤—ã–π —á–∞—Ç').slice(0,48) + ((o.lastUser || o.lastAssistant || '').length>48?'‚Ä¶':''), updatedAt:o.lastTs }))
              .sort((a,b)=>b.updatedAt - a.updatedAt);
            buildListFrom(arr);
            try { localStorage.setItem(listLSKey, JSON.stringify(arr)); } catch(_) {}
            return;
          }
          throw new Error('no data');
        }catch(_){
          try { const arr = JSON.parse(localStorage.getItem(listLSKey) || '[]'); buildListFrom(arr); } catch(__) {}
        }
      }

      refreshChatList();

      // New chat: reset stored chatId and clear message view
      if (newChatBtn) {
        newChatBtn.addEventListener('click', () => {
          try { localStorage.removeItem(chatKey); } catch(_) {}
          chatId = null;
          messagesEl.innerHTML = '';
          appendMessage('New chat started. Say something! üôÇ', 'left');
          inputEl.focus();
        });
      }
    }
  </script>
  <script>
    // Ensure EN notice on New chat even if earlier handler added another message
    document.addEventListener('click', function(e){
      var btn = e.target && (e.target.closest ? e.target.closest('#newChatBtn') : null);
      if (btn) {
        setTimeout(function(){
          try {
            var m = document.getElementById('messages');
            if (!m) return;
            m.innerHTML = '';
            var el = document.createElement('div');
            el.className = 'msg left';
            el.textContent = 'New chat started. Say something! üôÇ';
            m.appendChild(el);
          } catch(_) {}
        }, 0);
      }
    });
  </script>
</body>
</html>
