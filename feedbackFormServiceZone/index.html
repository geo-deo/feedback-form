<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Feedback Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-6">Feedback Admin</h1>

  <div class="flex gap-3 mb-4">
    <input id="search" placeholder="Search..." class="border rounded-lg px-3 py-2" />
    <input type="date" id="dateFrom" class="border rounded-lg px-3 py-2" />
    <input type="date" id="dateTo" class="border rounded-lg px-3 py-2" />
    <button onclick="loadData(1)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
      Apply
    </button>
  </div>

  <div id="pagination" class="mb-4"></div>
  
  <div class="flex items-center gap-3 mb-4">
    <span class="text-gray-600">API base:</span>
    <code id="apiBaseView" class="px-2 py-1 bg-gray-200 rounded"></code>

    <span class="ml-auto text-gray-600">Admin token:</span>
    <input id="adminToken" type="text" placeholder="X-Admin-Token (optional)"
           class="border rounded-lg px-3 py-2 w-64" />
    <button class="border px-3 py-2 rounded-lg hover:bg-gray-50" id="saveTokenBtn">Save</button>
    <button class="border px-3 py-2 rounded-lg hover:bg-gray-50" id="clearTokenBtn">Clear</button>

    <span id="status" class="text-sm text-gray-500"></span>
  </div>

  <div class="overflow-x-auto bg-white shadow rounded-lg">
    <table class="w-full border-collapse">
      <thead class="bg-gray-50 text-sm text-gray-600">
        <tr>
          <th class="px-3 py-2 text-left">Name</th>
          <th class="px-3 py-2 text-left">Email</th>
          <th class="px-3 py-2 text-left">Message</th>
          <th class="px-3 py-2 text-left">Created</th>
          <th class="px-3 py-2 text-left">Meta</th>
          <th class="px-3 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="tbody" class="divide-y">
        <tr><td colspan="6" class="text-center text-gray-500 p-4">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <script src="./config.js"></script>
  <script>
    const API_BASE = window.APP_CONFIG.API_BASE;
  </script>

  <!-- оставляем твой JS -->
  <script>
    const TOKEN_KEY = 'admin_token';
    const $ = (sel) => document.querySelector(sel);
    const state = { items: [], editing: new Set() };
    const ui = { page: 1, limit: 5, totalPages: 1 };

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d)) return iso || '';
        return d.toLocaleString();
      } catch { return iso || ''; }
    }
    function headersJson() {
      const h = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem(TOKEN_KEY);
      if (token) h['X-Admin-Token'] = token;
      return h;
    }
    function setStatus(msg) { $('#status').textContent = msg || ''; }

    async function deleteFeedback(id) {
      if (!confirm('Удалить запись?')) return;
      setStatus('Deleting…');
      try {
        const res = await fetch(`${API_BASE}/api/feedback/${id}`, {
          method: 'DELETE', headers: headersJson()
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Delete failed');
        state.items = state.items.filter(x => x.id !== id);
        state.editing.delete(id);
        render();
        setStatus('Deleted');
      } catch (e) { alert('Delete failed: ' + e.message); setStatus('Error'); }
    }

    async function updateFeedback(id, partial) {
      setStatus('Saving…');
      try {
        const res = await fetch(`${API_BASE}/api/feedback/${id}`, {
          method: 'PATCH', headers: headersJson(),
          body: JSON.stringify(partial),
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Update failed');
        const idx = state.items.findIndex(x => x.id === id);
        if (idx >= 0) state.items[idx] = { ...state.items[idx], ...partial };
        state.editing.delete(id);
        render();
        setStatus('Saved');
      } catch (e) { alert('Update failed: ' + e.message); setStatus('Error'); }
    }

    async function loadData(page = 1) {
      ui.page = page;
      const search = ($('#search')?.value || '').trim();
      const dateFrom = $('#dateFrom')?.value || '';
      const dateTo = $('#dateTo')?.value || '';
      const qs = new URLSearchParams({ page: String(ui.page), limit: String(ui.limit), search, dateFrom, dateTo });

      setStatus('Loading…');
      try {
        const res = await fetch(`${API_BASE}/api/feedback?${qs}`, { headers: headersJson() });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Failed to load');
        state.items = data.data || data.items || [];
        ui.totalPages = data.totalPages || 1;
        render(); renderPagination();
        setStatus(`Loaded ${state.items.length} (page ${ui.page}/${ui.totalPages})`);
      } catch (e) {
        console.error(e);
        $('#tbody').innerHTML = `<tr><td colspan="6" class="text-gray-500 text-center p-4">Error: ${e.message}</td></tr>`;
        setStatus('Error');
      }
    }

    function renderPagination() {
      const host = document.getElementById('pagination');
      if (!host) return;
      if (ui.totalPages <= 1) { host.innerHTML = ''; return; }
      const { page, totalPages } = ui;
      let html = `<div class="flex gap-2 items-center">`;
      html += `<button ${page<=1?'disabled':''} onclick="loadData(${page-1})" class="px-3 py-1 border rounded">« Prev</button>`;
      const pages = [];
      for (let p = 1; p <= totalPages; p++) {
        if (p === 1 || p === totalPages || Math.abs(p - page) <= 1) pages.push(p);
      }
      let last = 0;
      for (const p of pages) {
        if (p - last > 1) html += `<span>…</span>`;
        html += `<button ${p===page?'disabled':''} onclick="loadData(${p})" class="px-3 py-1 border rounded ${p===page?'bg-blue-600 text-white':''}">${p}</button>`;
        last = p;
      }
      html += `<button ${page>=totalPages?'disabled':''} onclick="loadData(${page+1})" class="px-3 py-1 border rounded">Next »</button>`;
      html += `</div>`;
      host.innerHTML = html;
    }

    function enterEditMode(id) { state.editing.add(id); render(); }
    function cancelEdit(id) { state.editing.delete(id); render(); }
    function saveRow(id) {
      const row = document.querySelector(`[data-id="${id}"]`);
      const name = row.querySelector('input[name="name"]').value.trim();
      const email = row.querySelector('input[name="email"]').value.trim();
      const message = row.querySelector('textarea[name="message"]').value.trim();
      if (!name || !email || !message) {
        alert('Name, Email и Message обязательны'); return;
      }
      updateFeedback(id, { name, email, message });
    }

    function render() {
      const rows = state.items.map(item => {
        const isEdit = state.editing.has(item.id);
        if (!isEdit) {
          return `<tr data-id="${item.id}">
              <td class="px-3 py-2">${escapeHtml(item.name)}</td>
              <td class="px-3 py-2">${escapeHtml(item.email)}</td>
              <td class="px-3 py-2">${nl2br(escapeHtml(item.message))}</td>
              <td class="px-3 py-2">${fmtDate(item.createdAt)}</td>
              <td class="px-3 py-2 text-sm text-gray-500">
                <div><b>IP:</b> ${escapeHtml(item.ip || '')}</div>
                <div><b>UA:</b> ${escapeHtml((item.userAgent || '').slice(0, 50))}${(item.userAgent||'').length>50?'…':''}</div>
              </td>
              <td class="px-3 py-2 flex gap-2">
                <button class="px-3 py-1 border rounded bg-blue-50 hover:bg-blue-100" onclick="enterEditMode('${item.id}')">Edit</button>
                <button class="px-3 py-1 border rounded bg-red-50 hover:bg-red-100" onclick="deleteFeedback('${item.id}')">Delete</button>
              </td>
            </tr>`;
        } else {
          return `<tr data-id="${item.id}">
              <td class="px-3 py-2"><input name="name" type="text" value="${attr(item.name)}" class="border rounded px-2 py-1 w-full"></td>
              <td class="px-3 py-2"><input name="email" type="email" value="${attr(item.email)}" class="border rounded px-2 py-1 w-full"></td>
              <td class="px-3 py-2"><textarea name="message" class="border rounded px-2 py-1 w-full">${attr(item.message)}</textarea></td>
              <td class="px-3 py-2">${fmtDate(item.createdAt)}</td>
              <td class="px-3 py-2 text-sm text-gray-500">
                <div><b>IP:</b> ${escapeHtml(item.ip || '')}</div>
                <div><b>UA:</b> ${escapeHtml((item.userAgent || '').slice(0, 50))}${(item.userAgent||'').length>50?'…':''}</div>
              </td>
              <td class="px-3 py-2 flex gap-2">
                <button class="px-3 py-1 border rounded bg-blue-600 text-white" onclick="saveRow('${item.id}')">Save</button>
                <button class="px-3 py-1 border rounded" onclick="cancelEdit('${item.id}')">Cancel</button>
              </td>
            </tr>`;
        }
      }).join('');
      $('#tbody').innerHTML = rows || `<tr><td colspan="6" class="text-center text-gray-500 p-4">Empty</td></tr>`;
    }

    function escapeHtml(s) { return String(s ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
    function attr(s) { return String(s ?? '').replace(/&/g,'&amp;').replace(/"/g,'&quot;'); }
    function nl2br(s) { return String(s).replace(/\n/g, '<br>'); }

    (function init() {
      $('#apiBaseView').textContent = API_BASE;
      $('#adminToken').value = localStorage.getItem(TOKEN_KEY) || '';
      $('#saveTokenBtn').addEventListener('click', () => {
        localStorage.setItem(TOKEN_KEY, $('#adminToken').value.trim());
        setStatus('Token saved'); loadData(1);
      });
      $('#clearTokenBtn').addEventListener('click', () => {
        localStorage.removeItem(TOKEN_KEY);
        $('#adminToken').value = '';
        setStatus('Token cleared'); loadData(1);
      });
      loadData(1);
    })();

    window.enterEditMode = enterEditMode;
    window.cancelEdit = cancelEdit;
    window.saveRow = saveRow;
    window.deleteFeedback = deleteFeedback;
    window.loadData = loadData;
  </script>
</body>
</html>