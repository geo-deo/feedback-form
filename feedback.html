<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback — админ-просмотр</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <header class="flex flex-wrap items-center gap-4 mb-6">
    <h1 class="text-2xl font-bold">Feedback</h1>
    <span id="total" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-full text-sm">0</span>
    <input id="q" type="search" placeholder="Поиск: имя, email, сообщение…" 
           class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none min-w-[240px]" />
    <button id="refresh" 
            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
      Обновить
    </button>
    <span id="updated" class="text-gray-500 text-sm"></span>
  </header>

  <div id="error" class="text-red-600 mb-4 hidden"></div>

  <div class="overflow-x-auto bg-white shadow rounded-lg">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="py-2 px-4 text-left">Время</th>
          <th class="py-2 px-4 text-left">Имя</th>
          <th class="py-2 px-4 text-left">Email</th>
          <th class="py-2 px-4 text-left">Сообщение</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr>
          <td colspan="4" class="py-6 text-center text-gray-500">Загрузка…</td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const API = "http://localhost:3001/api/feedback";
    const rowsEl = document.getElementById("rows");
    const totalEl = document.getElementById("total");
    const errorEl = document.getElementById("error");
    const updatedEl = document.getElementById("updated");
    const qEl = document.getElementById("q");
    const refreshBtn = document.getElementById("refresh");

    let data = [];

    function fmtDate(iso) {
      const d = iso ? new Date(iso) : null;
      return d && !isNaN(d) ? d.toLocaleString() : "—";
    }

    function render() {
      const q = (qEl.value || "").toLowerCase();
      const filtered = !q ? data : data.filter(item => {
        const hay = [
          item.name, item.email, item.message,
          item.createdAt, item.created_at, item.timestamp
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });

      rowsEl.innerHTML = "";
      if (filtered.length === 0) {
        rowsEl.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-gray-500">Ничего не найдено</td></tr>`;
      } else {
        rowsEl.innerHTML = filtered.map(item => {
          const created = item.createdAt || item.created_at || item.timestamp;
          return `
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
              <td class="py-2 px-4 whitespace-nowrap">${fmtDate(created)}</td>
              <td class="py-2 px-4">${item.name || ""}</td>
              <td class="py-2 px-4">${item.email || ""}</td>
              <td class="py-2 px-4 whitespace-pre-wrap">${item.message || ""}</td>
            </tr>
          `;
        }).join("");
      }
      totalEl.textContent = filtered.length;
      updatedEl.textContent = "Обновлено: " + new Date().toLocaleTimeString();
    }

async function load() {
  errorEl.classList.add("hidden");
  try {
    const res = await fetch(API);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    // ищем массив
    if (Array.isArray(json)) {
      data = json;
    } else if (Array.isArray(json.items)) {
      data = json.items;
    } else if (Array.isArray(json.data)) {
      data = json.data;
    } else {
      data = [];
    }

    data.sort((a, b) =>
      Date.parse(b.createdAt || b.timestamp) -
      Date.parse(a.createdAt || a.timestamp)
    );
    render();
  } catch (e) {
    rowsEl.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-red-600">Ошибка загрузки</td></tr>`;
    errorEl.textContent = "Не удалось получить данные: " + e.message;
    errorEl.classList.remove("hidden");
  }
}


    qEl.addEventListener("input", render);
    refreshBtn.addEventListener("click", load);
    setInterval(load, 15000);
    load();
  </script>
</body>
</html>